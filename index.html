<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Í≥†Ìñ•</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    overflow: hidden;
    background: url("gpttest.png") no-repeat center center fixed;
    background-size: cover;
}

.stage {
    position: relative;
    width: 100vw;
    height: 100vh;
}

.video-panel {
    position: absolute;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    width: 700px;
    aspect-ratio: 16 / 9;
    z-index: 1;
}
.video-panel iframe {
    width: 100%;
    height: 100%;
}

.character {
    position: absolute;
    text-align: center;
    cursor: pointer;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
}

.info-box {
    background: white;
    padding: 4px 8px;
    border: 1px solid #333;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
}

.bubble {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 12px;
    border: 1px solid black;
    border-radius: 4px;
    white-space: nowrap;
    display: none;
    margin-bottom: 5px;
    background: white;
    opacity: 0.85;
}

.video-input {
    position: fixed;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    z-index: 20;
}

.chatbox {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    z-index: 20;
}
.chatbox input {
    width: 360px;
    height: 44px;
    font-size: 16px;
}
.chatbox button {
    width: 100px;
    height: 44px;
    font-size: 15px;
}

.chat-log {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    width: 520px;
    height: 200px;
    background: rgba(255,255,255,0.6);
    border-radius: 0;
    padding: 10px;
    overflow-y: auto;
    font-size: 14px;
    display: none;
    z-index: 20;
}
</style>
</head>

<body>

<div class="video-input">
    <input id="videoLink" placeholder="Ïú†ÌäúÎ∏å ÎßÅÌÅ¨">
    <button id="videoBtn">Ïû¨ÏÉù</button>
</div>

<div class="stage">

    <div class="video-panel">
        <iframe id="yt"
        src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&mute=1"
        frameborder="0"
        allow="autoplay"></iframe>
    </div>

    <div class="character" id="charA" style="left:150px; top:120px;">
        <img src="wnajrqkqznddi.jpg" width="180">
        <div class="info-box" id="infoA">over | 0Î∂Ñ 0Ï¥à (OFF)</div>
        <button id="timerA">ÏãúÍ∞Ñ Ï∏°Ï†ï (click)</button>
        <div class="bubble" id="bubbleA"></div>
    </div>

    <div class="character" id="charB" style="left:500px; top:120px;">
        <img src="dhksrPznddi.jpg" width="140">
        <div class="info-box" id="infoB">Lilreaders | 0Î∂Ñ 0Ï¥à (OFF)</div>
        <button id="timerB">ÏãúÍ∞Ñ Ï∏°Ï†ï (click)</button>
        <div class="bubble" id="bubbleB"></div>
    </div>

</div>

<div class="chat-log" id="chatLog"></div>

<div class="chatbox">
    <input id="chatInput" placeholder="Ï±ÑÌåÖ ÏûÖÎ†•">
    <button id="sendBtn">Î≥¥ÎÇ¥Í∏∞</button>
    <button id="logBtn">Ï±ÑÌåÖÎ°úÍ∑∏</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, addDoc, collection, serverTimestamp, query, orderBy } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* Firebase ÏÑ§Ï†ï */
const firebaseConfig = {
  apiKey: "AIzaSyChjU0-QXRJptCvP9zYMaf-wDd4-kWkCAM",
  authDomain: "hometown-47a5f.firebaseapp.com",
  projectId: "hometown-47a5f",
  storageBucket: "hometown-47a5f.firebasestorage.app",
  messagingSenderId: "599624185810",
  appId: "1:599624185810:web:e99ce371c3e47591357a0b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ ---------- */

function extractVideoId(url) {
    const patterns = [/v=([^&]+)/,/youtu\.be\/([^?]+)/,/embed\/([^?]+)/];
    for (let p of patterns) {
        const m = url.match(p);
        if (m) return m[1];
    }
    return null;
}

/* üîÅ Ïú†ÌäúÎ∏å Í≥µÏú† */
async function changeVideo() {
    const id = extractVideoId(videoLink.value.trim());
    if (!id) { alert("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎßÅÌÅ¨ÏóêÏöî!"); return; }

    await setDoc(doc(db, "room", "video"), {
        videoId: id,
        updatedAt: serverTimestamp()
    });
}

onSnapshot(doc(db, "room", "video"), (snap) => {
    if (!snap.exists()) return;
    const { videoId } = snap.data();
    yt.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1`;
});

let selected = null;
charA.onclick = () => { if (!selected) selected = "A"; };
charB.onclick = () => { if (!selected) selected = "B"; };

document.addEventListener("keydown", e => {
    if (e.key === "/") {
        e.preventDefault();
        chatInput.focus();
    }
});

chatInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendChat();
});

const MAX_LOG = 50;

/* üîÅ Ï±ÑÌåÖ Ï†ÑÏÜ° */
async function sendChat() {
    if (!selected) { alert("Ï∫êÎ¶≠ÌÑ∞Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!"); return; }
    const msg = chatInput.value.trim();
    if (!msg) return;

    await addDoc(collection(db, "room", "chat", "messages"), {
        sender: selected === "A" ? "over" : "Lilreaders",
        char: selected,
        text: msg,
        time: serverTimestamp()
    });

    chatInput.value = "";
}

/* üîÅ Ï±ÑÌåÖ ÏàòÏã† */
const chatQuery = query(collection(db, "room", "chat", "messages"), orderBy("time"));
onSnapshot(chatQuery, (snapshot) => {
    chatLog.innerHTML = "";
    snapshot.docs.slice(-MAX_LOG).forEach(doc => {
        const data = doc.data();
        const line = document.createElement("div");
        const time = data.time?.toDate().toLocaleTimeString() || "";
        line.innerHTML = `<b>[${data.sender}]</b> ${data.text}
            <span style="color:gray;font-size:12px;">${time}</span>`;
        chatLog.appendChild(line);
        showBubble(data.char, data.text);
    });
    chatLog.scrollTop = chatLog.scrollHeight;
});

function showBubble(id, msg) {
    const bubble = document.getElementById("bubble" + id);
    bubble.innerText = msg;
    bubble.style.display = "block";
    setTimeout(() => bubble.style.display = "none", 4000);
}

function toggleLog() {
    chatLog.style.display =
        chatLog.style.display === "none" ? "block" : "none";
}

const keys = {};
const speed = 3;
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function moveLoop() {
    if (selected) {
        const c = document.getElementById("char" + selected);
        let x = c.offsetLeft;
        let y = c.offsetTop;

        if (keys.ArrowLeft) x -= speed;
        if (keys.ArrowRight) x += speed;
        if (keys.ArrowUp) y -= speed;
        if (keys.ArrowDown) y += speed;

        const stage = document.querySelector(".stage");
        x = Math.max(0, Math.min(stage.offsetWidth - c.offsetWidth, x));
        y = Math.max(0, Math.min(stage.offsetHeight - c.offsetHeight, y));

        c.style.left = x + "px";
        c.style.top = y + "px";
    }
    requestAnimationFrame(moveLoop);
}
moveLoop();

let timers = {
    A: { time: Number(localStorage.timeA || 0), running: false },
    B: { time: Number(localStorage.timeB || 0), running: false }
};

setInterval(() => {
    ["A","B"].forEach(id => {
        if (timers[id].running) timers[id].time++;
        localStorage["time"+id] = timers[id].time;

        const m = Math.floor(timers[id].time / 60);
        const s = timers[id].time % 60;
        const name = id === "A" ? "over" : "Lilreaders";
        document.getElementById("info"+id).innerText =
            `${name} | ${m}Î∂Ñ ${s}Ï¥à (${timers[id].running ? "ON" : "OFF"})`;
    });
}, 1000);

function toggleTimer(id) {
    timers[id].running = !timers[id].running;
}

/* ---------- Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© (Î™®Îìà ÎåÄÏùë ÌïµÏã¨ ÏàòÏ†ï) ---------- */
videoBtn.onclick = changeVideo;
sendBtn.onclick = sendChat;
logBtn.onclick = toggleLog;
timerA.onclick = () => toggleTimer("A");
timerB.onclick = () => toggleTimer("B");
</script>

</body>
</html>
